@model List<BookingList>
@{
	ViewData["Title"] = "BookingList";
	Layout = "~/Views/Shared/_AdminLayout.cshtml";
}


<script src="~/lib/microsoft/signalr/dist/browser/signalr.min.js"></script>
<script src="~/lib/jquery/dist/jquery.min.js"></script>
<script src="~/lib/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
<script src="~/js/site.js" asp-append-version="true"></script>

<script type="text/javascript">
	$(document).ready(() => {
		// 1. Bağlantıyı tanımla
		var connection = new signalR.HubConnectionBuilder()
			.withUrl("https://localhost:7042/SignalRHub")
			.withAutomaticReconnect() // Bağlantı koparsa kendi kendine tekrar denesin
			.build();

		// Bağlantı durumunu başta yaz
		$("#connstatus").text(connection.state);

		// 2. Veri Geldiğinde Ekrana Yaz (Dinleyiciler)
		connection.on("BookingList", (values) => {
			$("#bookingtable").empty();
			let htmltable = `<table class="table mt-3">
				<thead>
					<tr>
						<th scope="col">ID</th>
						<th scope="col">Ad-Soyad</th>
						<th scope="col">Telefon</th>
						<th scope="col">Mail</th>
						<th scope="col">Kişi Sayısı</th>
						<th scope="col">Tarih</th>
						<th scope="col">Durum</th>
						<th scope="col">Durum Değiştir</th>
						<th scope="col">Sil</th>
						<th scope="col">Güncelle</th>
					</tr>
				</thead>`;

				$.each(values,(index,item) =>{
					let dateFormatted = new Date(item.date).toLocaleDateString();
			let timeFormatted = new Date(item.date).toLocaleTimeString();
	htmltable+= `<tr>
							<td>${item.bookingID}</td>
							<td>${item.name}</td>
							<td>${item.phone}</td>
							<td>${item.mail}</td>
							<td>${item.personCount}</td>
							<td>${dateFormatted} ${timeFormatted}</td>
							<td>${item.status}</td>`;
							if(item.status=="Onay Bekleniyor" ||item.status=="Rezervasyon İptal Edildi" ){
								htmltable+=`

								<td>
			<form method="post" action="/Booking/UpdateSuccess">
				<input type="hidden" name="id" value="${item.bookingID}" />
				<button type="submit" class="btn btn-outline-success">Onayla</button>
			</form>
		</td>`;

							}
									if(item.status == "Rezervasyon Onaylandı"){
		htmltable += `
		<td>
			<form method="post" action="/Booking/UpdateCancel">
				<input type="hidden" name="id" value="${item.bookingID}" />
				<button type="submit" class="btn btn-outline-primary">İptal Et</button>
			</form>
		</td>`;
	}

							htmltable+=`<td><a href="/Booking/DeleteBooking/${item.bookingID}" class="btn btn-outline-danger">Sil</a></td>
							<td><a href="/Booking/UpdateBooking/${item.bookingID}" class="btn btn-outline-primary">Güncelle</a></td>
						</tr>`;

				});
				htmltable+=`</tbody>
			</table>`;
			$("#bookingtable").html(htmltable);
		});




		// 3. Bağlantıyı Başlat
		connection.start().then(() => {
			$("#connstatus").text("Bağlandı");
			$("#connstatus").css("color", "green");
		}).catch((err) => {
			console.error(err);
			$("#connstatus").text("Bağlantı Hatası");
		});

		// 4. GÜVENLİ ZAMANLAYICI (Hata verdirmeyen kısım burası)
		setInterval(() => {
			// SADECE ve SADECE bağlantı varsa istek at
			if (connection.state === "Connected") {
				connection.invoke("Booking").catch(err => console.error(err));
			}
			// Bağlantı yoksa hiçbir şey yapma (Böylece hata sayısı artmaz)
		}, 1000);

	});
</script>


<div class="col-md-12">
	<div class="card">
		<div class="card-header">
			<div class="card-title">Rezervasyon Tablosu</div>
		</div>
		<div class="card-body">
			<div id="bookingtable">
			</div>
			<a href="/Booking/AddBooking" class="btn btn-outline-warning">Rezervasyon Ekle</a>
			<div class="col-md-8">
				<ul class="list-group" id="bookingtable"></ul>
			</div>
		</div>
	</div>
</div>

